---
title: "5-Scoring Endothelial cells"
author: "Joan Abinet"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
  header-includes:
    -|
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 65), tidy = TRUE)
```

\newpage

# Introduction

Gene signatures specific of transcriptional change in gCap were obtained by selecting the top 20 genes with the highest absolute log fold-change in each condition (control and MarNeu-targeted). The 2 signatures were then tested on Murine endothelial cells from different tissues. using the AddModuleScore function.


# Loading packages
```{r}
suppressMessages({
  library(dplyr)
  library(Seurat)
  library(patchwork)
  library(ggplot2)
  library(formatR)
  library(dittoSeq)
  library(ggrepel)
  library(xlsx)
})
```

# Loading Annotated cell
```{r}
endothelial_cells <- readRDS("../02-Clustering_Endo/endothelial_cells_annotated.rds")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")
DimPlot(endothelial_cells, group.by = "CellType", cols = color)
```

# Calculate gene signature for the PBS and Treated cells
```{r}
endothelial_cells_subset <-subset(endothelial_cells, CellType %in% "1 general capillaries")

Markers.PBSTreated <- FindMarkers(endothelial_cells_subset, ident.1 = "PBS", ident.2 = c("aCXCR2-D14","aLy6G-D14"),  min.pct = 0.25, group.by = "Condition")

Markers.PBSTreated <- Markers.PBSTreated[order(Markers.PBSTreated$avg_log2FC, decreasing = T),]

signature_PBS <- rownames(Markers.PBSTreated)[1:20]

signature_treated <- tail(rownames(Markers.PBSTreated),20)
```


# data from reference atlas
The raw counts and the metadata can be downloaded in https://endotheliomics.shinyapps.io/ec_atlas/
```{r}
Count_matrix <- read.csv("Data_endoMuris/Data.csv")
rownames(Count_matrix) <- Count_matrix[,1]
Count_matrix <- Count_matrix[,-1]

metadata <- read.csv("Data_endoMuris/Metadata.csv")
rownames(metadata) <- metadata$Observation

endo_cells_atlas <- CreateSeuratObject(Count_matrix, project = "Murine Endothelial Cells", meta.data = metadata)
endo_cells_atlas <- AddMetaData(endo_cells_atlas, metadata)
```

# Score Treated
```{r}
endo_cells_atlas <- AddModuleScore(endo_cells_atlas,
                  features = list(signature_treated),
                  name= "Treated_sign")

VlnPlot(endo_cells_atlas, features = "Treated_sign1", group.by = "Tissue")
# ggsave("endo_atlas_treated.png", width = 12, height = 8)

Treated_Score <- FetchData(endo_cells_atlas, vars = c("Treated_sign1","Tissue"))
# write.xlsx(Treated_Score, "Scoring_endo_treated.xlsx", rowNames = T)
```

# Score PBS
```{r}
endo_cells_atlas <- AddModuleScore(endo_cells_atlas,
                  features = list(signature_PBS),
                  name= "PBS_sign")

VlnPlot(endo_cells_atlas, features = "PBS_sign1", group.by = "Tissue")
# ggsave("endo_atlas_PBS.png", width = 12, height = 8)

PBS_Score <- FetchData(endo_cells_atlas, vars = c("PBS_sign1","Tissue"))
# write.xlsx(PBS_Score, "Scoring_endo_PBS.xlsx", rowNames = T)
```

Endothelial cell scores were subsequently normalized and expressed relative to brain endothelial cells. The results were plotted into violin plot with prism.


```{r}
sessionInfo()
```

