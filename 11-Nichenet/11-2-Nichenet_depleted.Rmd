---
title: "11-2-Nichenet-Depleted"
author: "Joan Abinet"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
  header-includes:
    -|
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 65), tidy = TRUE)
```

\newpage

# Introduction

The NicheNet package was used to investigate ligand–target interactions. gCap endothelial cells (ECs) were defined as sender cells, and neutrophils as receiver cells. Two gene sets of interest were used for the analysis: one consisting of genes significantly upregulated in the PBS control condition, and the other consisting of genes upregulated in the MarNeu-depleted condition. Ligand prioritization was performed separately for each gene set to identify ligands in sender cells most likely to regulate the observed gene expression in receiver cells. In both cases, the top predicted ligand–target interactions were visualized using circos plots.

The following code was performed based on the vignette available in https://github.com/saeyslab/nichenetr/blob/master/vignettes/circos.md

The ligand receptor network and the ligand target matrix are both available on Zenodo
lr_network <- readRDS(url("https://zenodo.org/record/7074291/files/lr_network_human_21122021.rds"))
ligand_target_matrix <- readRDS(url("https://zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final.rds"))


# Loading packages
```{r}
suppressMessages({
  
  library(dplyr)
  library(Seurat)
  library(patchwork)
  library(ggplot2)
  library(nichenetr)
  library(tidyverse)
  library(circlize)
})
```


# Loading Annotated gCap
```{r}
endothelial_cells <- readRDS("../02-Clustering_Endo/endothelial_cells_annotated.rds")
Capillary_cells <-subset(endothelial_cells, CellType %in% "1 general capillaries")
Capillary_cells <- subset(Capillary_cells, Condition %in% c("aCXCR2-D14","aLy6G-D14"))
```

# Loading Neutro
```{r}
neutro_depletion <- readRDS("../06-Neutrophils_Processing/neutro_depleted_Part1.rds")
```

# Define expressed genes in Gcap and neutro
```{r, message=FALSE, warning=FALSE, results= "hide"}
expression_endo = Capillary_cells@assays$RNA@counts
sample_info_endo = Capillary_cells@meta.data
expression_endo <- as.matrix(expression_endo)
expression_endo <- t(expression_endo)

expression_neutro = neutro_depletion@assays$RNA@counts
sample_info_neutro = neutro_depletion@meta.data
expression_neutro <- as.matrix(expression_neutro)
expression_neutro <- t(expression_neutro)
```

# Define expressed ligands and receptors
```{r}
Endo_ids <- CellsByIdentities(object = Capillary_cells)$`1 general capillaries`

neutro_ids <- CellsByIdentities(object = neutro_depletion)
neutro_ids <- unlist(neutro_ids)

expressed_genes_Endo = expression_endo[Endo_ids,] %>% apply(2,function(x){10*(2**x - 1)}) %>% apply(2,function(x){log2(mean(x) + 1)}) %>% .[. >= 4] %>% names()
expressed_genes_neutro = expression_neutro[neutro_ids,] %>% apply(2,function(x){10*(2**x - 1)}) %>% apply(2,function(x){log2(mean(x) + 1)}) %>% .[. >= 4] %>% names()
```


# Load the ligand-target model 
```{r}
# adapt to the file path of your own system
ligand_target_matrix <- readRDS(file = "/mnt/Data/NicheNet_database/mouse_ligand_target_matrix.Rds")
```

# Load the gene set of interest and background of genes
```{r}
DE_PBS_treated = FindMarkers(object = neutro_depletion, ident.1 = "PBS", ident.2 = c("acxcr2","aLy6G"), min.pct = 0.10, group.by = "orig.ident") %>% rownames_to_column("gene")
DE_PBS_treated <- DE_PBS_treated[order(abs(DE_PBS_treated$avg_log2FC), decreasing = T),]
DE_PBS_treated <- DE_PBS_treated[DE_PBS_treated$avg_log2FC <0,]

geneset <- DE_PBS_treated$gene
geneset <- unique(geneset) # 34

background_expressed_genes = expressed_genes_neutro %>% .[. %in% rownames(ligand_target_matrix)]
```

# Define potential ligand
```{r, message=FALSE, warning=FALSE, results= "hide"}
# adapt to the file path of your own system
lr_network <- readRDS(file = "/mnt/Data/NicheNet_database/mouse_lr_network.Rds")

ligands = lr_network %>% pull(from) %>% unique()
expressed_ligands_endo = intersect(ligands,expressed_genes_Endo)

receptors = lr_network %>% pull(to) %>% unique()
expressed_receptors = intersect(receptors,expressed_genes_neutro)

potential_ligands = lr_network %>% filter(from %in% expressed_ligands_endo & to %in% expressed_receptors) %>% pull(from) %>% unique()
head(potential_ligands)
```

# Perform NicheNet’s ligand activity analysis on the gene set of interest
```{r, message=FALSE, warning=FALSE, results= "hide"}
ligand_activities = predict_ligand_activities(geneset = geneset, background_expressed_genes = background_expressed_genes, ligand_target_matrix = ligand_target_matrix, potential_ligands = potential_ligands)

ligand_activities %>% arrange(-aupr_corrected) 
```

```{r}
best_upstream_ligands = ligand_activities %>% top_n(20, aupr_corrected) %>% arrange(-aupr_corrected) %>% pull(test_ligand)
head(best_upstream_ligands)
```

```{r, message=FALSE, warning=FALSE, results= "hide"}
ggplot(ligand_activities, aes(x=aupr_corrected)) + 
  geom_histogram(color="black", fill="darkorange")  + 
  geom_vline(aes(xintercept=min(ligand_activities %>% top_n(20, aupr_corrected) %>% pull(aupr_corrected))),
             color="red", linetype="dashed", size=1) + 
  labs(x="ligand activity (PCC)", y = "# ligands") +
  theme_classic()
```

```{r}
ligand_type_indication_df = tibble(
  ligand_type = c(rep("Endothelial-specific", times = best_upstream_ligands %>% length())),
  ligand = c(best_upstream_ligands))
```

# Infer target genes of top-ranked ligands and visualize in a circos plot
```{r, message=FALSE, warning=FALSE, results= "hide"}
active_ligand_target_links_df = best_upstream_ligands %>% lapply(get_weighted_ligand_target_links,geneset = geneset, ligand_target_matrix = ligand_target_matrix, n = 250) %>% bind_rows()

active_ligand_target_links_df <- na.omit(active_ligand_target_links_df)

active_ligand_target_links_df = active_ligand_target_links_df %>% mutate(target_type = "neutro-specific") %>% inner_join(ligand_type_indication_df) 
```

# Filter low score link
```{r}
cutoff_include_all_ligands = active_ligand_target_links_df$weight %>% quantile(0.66)

active_ligand_target_links_df_circos = active_ligand_target_links_df %>% filter(weight > cutoff_include_all_ligands)

ligands_to_remove = setdiff(active_ligand_target_links_df$ligand %>% unique(), active_ligand_target_links_df_circos$ligand %>% unique())
targets_to_remove = setdiff(active_ligand_target_links_df$target %>% unique(), active_ligand_target_links_df_circos$target %>% unique())
  
circos_links = active_ligand_target_links_df %>% filter(!target %in% targets_to_remove &!ligand %in% ligands_to_remove)

circos_links <- active_ligand_target_links_df_circos
```


```{r, message=FALSE, warning=FALSE, results= "hide"}
grid_col_ligand =c("Endothelial-specific" = "orange")

grid_col_target =c("neutro-specific" = "blue")

grid_col_tbl_ligand = tibble(ligand_type = grid_col_ligand %>% names(), color_ligand_type = grid_col_ligand)
grid_col_tbl_target = tibble(target_type = grid_col_target %>% names(), color_target_type = grid_col_target)

circos_links = circos_links %>% mutate(ligand = paste(ligand," ")) 
circos_links = circos_links %>% inner_join(grid_col_tbl_ligand) %>% inner_join(grid_col_tbl_target)
links_circle = circos_links %>% select(ligand,target, weight)

ligand_color = circos_links %>% distinct(ligand,color_ligand_type)
grid_ligand_color = ligand_color$color_ligand_type %>% set_names(ligand_color$ligand)
target_color = circos_links %>% distinct(target,color_target_type)
grid_target_color = target_color$color_target_type %>% set_names(target_color$target)

grid_col =c(grid_ligand_color,grid_target_color)

# give the option that links in the circos plot will be transparant ~ ligand-target potential score
transparency = circos_links %>% mutate(weight =(weight-min(weight))/(max(weight)-min(weight))) %>% mutate(transparency = 1-weight) %>% .$transparency 
```

```{r, message=FALSE, warning=FALSE, results= "hide"}
target_order = circos_links$target %>% unique()
ligand_order = best_upstream_ligands %>% c(paste(.," ")) %>% intersect(circos_links$ligand)
order = c(ligand_order,target_order)
```

# Prepare the circos visualization
```{r, message=FALSE, warning=FALSE, results= "hide"}
width_same_cell_same_ligand_type = 0.5
width_different_cell = 6
width_ligand_target = 15
width_same_cell_same_target_type = 0.5

gaps = c(
  # width_ligand_target,
  rep(width_same_cell_same_ligand_type, times = (circos_links %>% filter(ligand_type == "Endothelial-specific") %>% distinct(ligand) %>% nrow() -1)),
  width_ligand_target,
  rep(width_same_cell_same_target_type, times = (circos_links %>% filter(target_type == "neutro-specific") %>% distinct(target) %>% nrow() -1)),
  width_ligand_target
  )
```


```{r}
# pdf("CP_Endo_Neutro_Depleted.pdf", width = 8, height = 8) # measurement in inches 

circos.par(gap.degree = gaps)
chordDiagram(links_circle, directional = 1,order=order,link.sort = TRUE, link.decreasing = FALSE, grid.col = grid_col,transparency = transparency, diffHeight = 0.005, direction.type = c("diffHeight", "arrows"),link.arr.type = "big.arrow", link.visible = links_circle$weight >= cutoff_include_all_ligands,annotationTrack = "grid", 
    preAllocateTracks = list(track.height = 0.075))
# we go back to the first track and customize sector labels
circos.track(track.index = 1, panel.fun = function(x, y) {
    circos.text(CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index,
        facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.55), cex = 1)
}, bg.border = NA)

# dev.off()
```

```{r}
sessionInfo()
```


