---
title: "3-Perturbation Score"
author: "Joan Abinet"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
  header-includes:
    -|
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 65), tidy = TRUE)
```

\newpage

# Introduction

Differentially expressed genes (DEGs) between the MarNeu depleted and control conditions were identified for each cluster using the FindMarkers function from the Seurat package. Genes with an adjusted p-value < 0.05 and an average log fold change (logFC) > 0.25 or < -0.25 were considered significantly differentially expressed between the two conditions.

# Loading packages
```{r}
suppressMessages({
  library(dplyr)
  library(Seurat)
  library(patchwork)
  library(ggplot2)
  library(formatR)
  library(dittoSeq)
  library(ggrepel)
  library(xlsx)
})
```

# Loading annotated Cell
```{r}
endothelial_cells <- readRDS("../02-Clustering_Endo/endothelial_cells_annotated.rds")
```

# Perturbation score Day 14

## calculating number of gene
```{r, message=FALSE, warning=FALSE, echo=FALSE}
for (celltype in unique(endothelial_cells$CellType)) {
  
  sub_endothelial_cells <- subset(endothelial_cells, CellType %in% celltype)
  
  Markers_long <- FindMarkers(sub_endothelial_cells, ident.1 = "PBS", ident.2 = c("aCXCR2-D14","aLy6G-D14"), min.pct = 0.1, group.by = "Condition", logfc.threshold = 0.25)
  
  Markers_long <- Markers_long[Markers_long$p_val_adj < 0.05,]
  #write.xlsx(Markers_long, "Plot/DE_gene.xlsx", sheetName = celltype, col.names = T, append = T)
  
  print(paste0("The number of DEG for ",celltype," is ", length(rownames(Markers_long))))
  
}
```

## Feature Plot DEG number
```{r, message=FALSE, warning=FALSE, results= "hide", echo=FALSE}
endothelial_cells$DEG_num_long <- endothelial_cells$CellType
levels(endothelial_cells$DEG_num_long) <- c(65,16,22,2,21,1,13)

levels_as_integers <- as.integer(levels(endothelial_cells$DEG_num_long))
endothelial_cells$DEG_num_long <- levels_as_integers[as.integer(endothelial_cells$DEG_num_long)]

FeaturePlot(endothelial_cells, features = "DEG_num_long")
#ggsave("Plot/DEG_number_long.pdf", width = 8, height = 5)
```


## Volcano_plot in gCap
```{r}
endothelial_cells_subset <-subset(endothelial_cells, CellType %in% "1 general capillaries")

Markers_j14 <- FindMarkers(endothelial_cells_subset, ident.1 = "PBS", ident.2 = c("aCXCR2-D14","aLy6G-D14"), min.pct = 0.25, group.by = "Condition", logfc.threshold = 0)

Markers_j14$category <- ifelse(Markers_j14$p_val_adj < 0.05 & abs(Markers_j14$avg_log2FC) > 0.25, "overexpressed",ifelse(Markers_j14$p_val_adj < 0.05 & Markers_j14$avg_log2FC < 0.25, "significative",
                             "no significant"))

Markers_j14 <- Markers_j14[order(Markers_j14$avg_log2FC),]

Markers_j14$label <- NA
#order <- c(1,2,5,6,12,14,15,19,27)
gene_to_highlight <- c("Klf2", "Klf4", "Uba52", "Rps28", "Dusp1", "Plaur", "Rpl39", "Rpl37a", "Ifi47", "Tap1", "Gadd45g", "Wars", "Gbp4", "Igtp", "H2-DMa", "H2-Aa", "H2-Ab1", "H2-Eb1", "Cd74")
Markers_j14$label <- ifelse(rownames(Markers_j14) %in% gene_to_highlight, rownames(Markers_j14), NA)

ggplot(data = Markers_j14, aes(x = avg_log2FC, y = -log10(p_val_adj), col = category, label = label))+
  geom_point(size = 2, alpha = 1) + 
  theme_classic()+
  scale_color_manual(values = c("black", "red", "blue"))+
  geom_text_repel(data = na.omit(Markers_j14), size = 4, aes(label= gene_to_highlight, fontface = "italic"), colour = "black", force = 4)+
  NoLegend() +
  ylab(expression(-Log[10]*" P"))+
  xlab("LogFoldChange")+
  theme()+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", col = "grey")+
  geom_vline(xintercept = c(-0.25,0.25), linetype = "dashed", col = "grey")

#ggsave("Plot/Volcano_gcap_J14.pdf", width = 8, height = 5)
```

# Perturbation score Day 3

## calculating number of gene
```{r}
for (celltype in unique(endothelial_cells$CellType)) {
  
  endothelial_cells_subset <- subset(endothelial_cells, CellType %in% celltype)
  
  Markers_short <- FindMarkers(endothelial_cells_subset, ident.1 = "PBS", ident.2 = c("aCXCR2-D3","aLy6G-D3"), min.pct = 0.1, group.by = "Condition", logfc.threshold = 0.25)
  
  Markers_short <- Markers_short[Markers_short$p_val_adj < 0.05,]
  # write.xlsx(Markers_long, "Plot/DE_gene_J3.xlsx", sheetName = celltype, col.names = T, append = T)
  
  print(paste0("The number of DEG for ",celltype," is ", length(rownames(Markers_long))))
  
}
```

## Feature Plot DEG number
```{r}
endothelial_cells$DEG_num_long <- endothelial_cells$CellType
levels(endothelial_cells$DEG_num_long) <- c(72,27,46,0,28,1,16)

levels_as_integers <- as.integer(levels(endothelial_cells$DEG_num_long))
endothelial_cells$DEG_num_long <- levels_as_integers[as.integer(endothelial_cells$DEG_num_long)]

FeaturePlot(endothelial_cells, features = "DEG_num_long")
# ggsave("Plot/DEG_number_short.pdf", width = 8, height = 5)
```

## Volcano_plot in gCap
```{r}
endothelial_cells_subset <-subset(endothelial_cells, CellType %in% "1 general capillaries")

Markers_j3 <- FindMarkers(endothelial_cells_subset, ident.1 = "PBS", ident.2 = c("aCXCR2-D3","aLy6G-D3"), min.pct = 0.25, group.by = "Condition", logfc.threshold = 0)

Markers_j3$category <- ifelse(Markers_j3$p_val_adj < 0.05 & abs(Markers_j3$avg_log2FC) > 0.25, "overexpressed",ifelse(Markers_j3$p_val_adj < 0.05 & Markers_j3$avg_log2FC < 0.25, "significative",
                             "no significant"))

Markers_j3 <- Markers_j3[order(Markers_j3$avg_log2FC),]

gene_display <- c("Klf2", "Klf4", "Rps28", "Uba52", "Cdkn1a", "Rpl39", "Tap1", "Ifi47", "Gbp4", "Igtp", "H2-Dma", "H2-Dmb1", "H2-Aa", "H2-Ab1", "H2-Eb1", "Cd74")
Markers_j3$label <- NA
Markers_j3$label[c(2:4,13,17,40,3207, 3209, 3223,3226:3229,3231:3233)] <- rownames(Markers_j3)[c(2:4,13,17,40,3207, 3209, 3223,3226:3229,3231:3233)]

order<- c(2:4,13,17,40,3207, 3209, 3223,3226:3229,3231:3233)

Markers_j3 <- Markers_j3[order(Markers_j3$avg_log2F),]

ggplot(data = Markers_j3, aes(x = avg_log2FC, y = -log10(p_val_adj), col = category, label = label))+
  geom_point(size = 2, alpha = 1) + 
  theme_classic()+
  scale_color_manual(values = c("black", "red", "blue"))+
  geom_text_repel(data = Markers_j3[order,], size = 4, aes(label=Markers_j3$label[order], fontface = "italic"), colour = "black", force = 4)+
  NoLegend() +
  ylab(expression(-Log[10]*" P"))+
  xlab("LogFoldChange")+
  theme()+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", col = "grey")+
  geom_vline(xintercept = c(-0.25,0.25), linetype = "dashed", col = "grey")

# ggsave("Plot/Volcano_gcap_J3.pdf", width = 8, height = 5)
```

# Dotplot of perturbated genes in gCap
```{r}
DotPlot(endothelial_cells_subset, features = c("Cd74", "H2-Ab1", "H2-Eb1", "Vwf", "H2-DMa", "H2-DMb1", "Klf2", "Klf4", "Klf6"), group.by = "Condition")+ theme(axis.text.x = element_text(angle = 54, hjust = 1))
```


```{r}
sessionInfo()
```


