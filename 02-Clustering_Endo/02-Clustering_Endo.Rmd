---
title: "Clustering endothelial cells"
author: "Joan Abinet"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
  header-includes:
    -|
    ```{=latex}
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
      breaksymbolleft={}, 
      showspaces = false,
      showtabs = false,
      breaklines,
      commandchars=\\\{\}
    }
    ```
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 65), tidy = TRUE)
```

\newpage

# Introduction

A total of 11 clusters of endothelial cells were obtained using the FindClusters function (15 Principal Components were included and a resolutions of 0.25 was selected) and the differentially expressed genes (DEGs) were calculated using the FindAllMarkers function (Seurat package). Endothelial cells were subsequently categorized into 7 subpopulations using canonical marker genes.

# Loading packages
```{r}
suppressMessages({
  library(dplyr)
  library(Seurat)
  library(patchwork)
  library(ggplot2)
  library(formatR)
  library(dittoSeq)
  library(ComplexHeatmap)
})
```

# Load Seurat objects
```{r, message=FALSE}
endothelial_cells <- readRDS("../01-EndothelialCells_Preprocessing/endothelial_cells.rds")
```


# Reclustering the cells
```{r, message=FALSE, warning=FALSE, results= "hide"}
endothelial_cells <- FindNeighbors(endothelial_cells, dims = 1:15)
endothelial_cells <- FindClusters(endothelial_cells, resolution = 0.25)
endothelial_cells <- RunUMAP(endothelial_cells, dims = 1:15)
```


```{r}
DimPlot(endothelial_cells, reduction = "umap", label = T)
```

# Annotating cells
```{r, message=FALSE, warning=FALSE, results= "hide"}
endothelial_cells$CellType <- endothelial_cells$seurat_clusters
levels(endothelial_cells$CellType) <- c("1 general capillaries", "7 other", "2 aerocyte capilaries", "3 pulmonary veins", "5 arteries", "3 pulmonary veins", "2 aerocyte capilaries", "6 lymphaptics", "1 general capillaries", "4 systemic veins", "7 other", "1 general capillaries")


endothelial_cells$CellType <- factor(endothelial_cells$CellType, levels =  c("1 general capillaries", "2 aerocyte capilaries", "3 pulmonary veins", "4 systemic veins", "5 arteries", "6 lymphaptics", "7 other"))
Idents(endothelial_cells) <- "CellType"
```


```{r}
color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells, group.by = "CellType", cols = color, pt.size = 0.7) +
  theme(legend.text	 = element_text(size = 15), axis.line = element_line(linewidth = 1), axis.text = element_text(size = 14))+ ggtitle("")
#ggsave("Plot/UMAP_whole.pdf", height = 12 , width = 19, units = "cm")
```


# Cluster Frequency per condition
```{r}
endothelial_cells$Condition <- endothelial_cells$orig.ident
endothelial_cells$Condition <- as.factor(endothelial_cells$Condition)
levels(endothelial_cells$Condition) <- c("aCXCR2-D14", "aCXCR2-D3", "aLy6G-D14", "aLy6G-D3", "PBS")

bar_colors <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")
dittoBarPlot(endothelial_cells, "CellType", group.by = "Condition", color.panel = bar_colors, main = "")
#ggsave("bar_plot.pdf", width = 5, height = 3)
```


# Visualisation 

## Mock cells
```{r}
endothelial_cells_PBS <- subset(endothelial_cells, Condition %in% "PBS")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells_PBS, reduction = "umap", cols = color, group.by = "CellType") + plot_annotation(
  title = 'Endothelial - Cells - PBS ',
  theme = theme(plot.title = element_text(size = 16, hjust = 0.5)))

#ggsave("Plot/UMAP_mock.pdf", height = 12 , width = 19, units = "cm")
```

## aCXCR2 Day 3 cells
```{r}
endothelial_cells_aCXCR2_3 <- subset(endothelial_cells, Condition %in% "aCXCR2-D3")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells_aCXCR2_3, reduction = "umap", cols = color, group.by = "CellType") + plot_annotation(
  title = 'Endothelial Cells - aCXCR2 Day 3 ',
  theme = theme(plot.title = element_text(size = 16, hjust = 0.5)))

#ggsave("Plot/UMAP_aCXCR2_D3.pdf", height = 12 , width = 19, units = "cm")
```

## aLy6G Day 3 cells
```{r}
endothelial_cells_aLy6G_3 <- subset(endothelial_cells, Condition %in% "aLy6G-D3")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells_aLy6G_3, reduction = "umap", cols = color, group.by = "CellType") + plot_annotation(
  title = 'Endothelial Cells - aLy6G Day 3 ',
  theme = theme(plot.title = element_text(size = 16, hjust = 0.5)))

#ggsave("Plot/UMAP_aLy6G_D3.pdf", height = 12 , width = 19, units = "cm")
```

## aLy6G Day 14 cells
```{r}
endothelial_cells_aLy6G_14 <- subset(endothelial_cells, Condition %in% "aLy6G-D14")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells_aLy6G_14, reduction = "umap", cols = color, group.by = "CellType") + plot_annotation(
  title = 'Endothelial Cells - aLy6G Day 14 ',
  theme = theme(plot.title = element_text(size = 16, hjust = 0.5)))

#ggsave("Plot/UMAP_aLy6G_D14.pdf", height = 12 , width = 19, units = "cm")
```

## aCXCR2 Day 14 cells
```{r}
endothelial_cells_aCXCR2_14 <- subset(endothelial_cells, Condition %in% "aCXCR2-D14")

color <- c("#E63946", "#F07167", "#8AC926","#FFD700", "#6AAB9C", "#355070", "gray")

DimPlot(endothelial_cells_aCXCR2_14, reduction = "umap", cols = color, group.by = "CellType") + plot_annotation(
  title = 'Endothelial Cells - aCXCR2 Day 14 ',
  theme = theme(plot.title = element_text(size = 16, hjust = 0.5)))

#ggsave("Plot/UMAP_aCXCR2_D14.pdf", height = 12 , width = 19, units = "cm")
```

# Dotplot Annotated
```{r}
DotPlot(endothelial_cells, features = c("Aplnr","Col93","Plvap", "Car14", "Lpl", "Car4", "Apln", "Ednrb", "Tbx2", "Nr2f2", "Vwf", "C1qtnf9","Timp4","Vwa1","Meox2","Mgp", "Bmx", "Gja5","Ccl21a","Prox1"), group.by = "CellType") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
#ggsave("dotplot_endo.pdf", width = 8, height = 6)
```


```{r, message=FALSE, warning=FALSE, results= "hide" }
endo.markers <- FindAllMarkers(endothelial_cells, only.pos = TRUE, min.pct = 0.25)

endo.markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC) -> top10

mat <- as.matrix( GetAssayData(object = endothelial_cells, slot = "data")[as.character(top10$gene),])

df <- as.data.frame(endothelial_cells$CellType)
colnames(df) <- "Clusters"
color_df <- list(Clusters = c("1 general capillaries" = "#E63946", 
                              "2 aerocyte capilaries" = "#F07167", 
                              "3 pulmonary veins" = "#8AC926", 
                              "4 systemic veins" = "#FFD700", 
                              "5 arteries" = "#6AAB9C", 
                              "6 lymphaptics" = "#355070", 
                              "7 other" = "grey"))

Heatmap<- Heatmap(t(scale(t(mat))), show_column_names = F,
        column_split = endothelial_cells$CellType,
        cluster_column_slices = F,
        cluster_rows = F,
        top_annotation = HeatmapAnnotation(df = df, col = color_df),
        use_raster = F,
        show_heatmap_legend = F,
        show_column_dend = F,
        column_title_rot = 90,
        row_names_side = "left")

#tidyHeatmap::save_pdf(Heatmap, "Plot/Heatmap_endo.pdf", width = 35, height = 50, units ="cm")        
```

# Heatmap top genes per clusters
```{r fig.width=10, fig.height=20}
Heatmap
```

# saving results for later
```{r, eval=FALSE}
saveRDS(endothelial_cells, "endothelial_cells_annotated.rds")
```

```{r}
sessionInfo()
```

